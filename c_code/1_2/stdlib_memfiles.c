/* Generated by Nim Compiler v0.11.2 */
/*   (c) 2015 Andreas Rumpf */
/* The generated code is subject to the original license. */
#define NIM_INTBITS 64
#include "nimbase.h"

#include <string.h>
typedef struct Memfile234208 Memfile234208;
typedef struct NimStringDesc NimStringDesc;
typedef struct TGenericSeq TGenericSeq;
typedef struct TNimType TNimType;
typedef struct TNimNode TNimNode;
typedef N_STDCALL_PTR(void*, TY107429) (NI hfilemappingobject, NI32 dwdesiredaccess, NI32 dwfileoffsethigh, NI32 dwfileoffsetlow, NI32 dwnumberofbytestomap, void* lpbaseaddress);
struct  Memfile234208  {
void* mem;
NI size;
NI fhandle;
NI maphandle;
};
typedef N_STDCALL_PTR(NI32, TY107602) (void* lpbaseaddress);
struct  TGenericSeq  {
NI len;
NI reserved;
};
struct  NimStringDesc  {
  TGenericSeq Sup;
NIM_CHAR data[SEQ_DECL_SIZE];
};
typedef N_STDCALL_PTR(NI, TY107318) (NI16* lpfilename, NI32 dwdesiredaccess, NI32 dwsharemode, void* lpsecurityattributes, NI32 dwcreationdisposition, NI32 dwflagsandattributes, NI htemplatefile);
typedef N_STDCALL_PTR(NI32, TY105425) (NI hobject);
typedef N_STDCALL_PTR(NI32, TY107411) (NI hfile, NI32 ldistancetomove, NI32* lpdistancetomovehigh, NI32 dwmovemethod);
typedef N_STDCALL_PTR(NI32, TY107405) (NI hfile);
typedef N_STDCALL_PTR(NI, TY107440) (NI hfile, void* lpfilemappingattributes, NI32 flprotect, NI32 dwmaximumsizehigh, NI32 dwmaximumsizelow, void* lpname);
typedef N_STDCALL_PTR(NI32, TY107421) (NI hfile, NI32* lpfilesizehigh);
typedef N_NIMCALL_PTR(void, TY3289) (void* p, NI op);
typedef N_NIMCALL_PTR(void*, TY3294) (void* p);
struct  TNimType  {
NI size;
NU8 kind;
NU8 flags;
TNimType* base;
TNimNode* node;
void* finalizer;
TY3289 marker;
TY3294 deepcopy;
};
struct  TNimNode  {
NU8 kind;
NI offset;
TNimType* typ;
NCSTRING name;
NI len;
TNimNode** sons;
};
N_NIMCALL(void*, mapmem_234220)(Memfile234208* m, NU8 mode, NI mappedsize, NI offset);
static N_INLINE(NI, chckRange)(NI i, NI a, NI b);
N_NOINLINE(void, raiseRangeError)(NI64 val);
N_NIMCALL(void, raiseoserror_115430)(NI32 errorcode);
N_NIMCALL(NI32, oslasterror_115454)(void);
static N_INLINE(void, nimFrame)(TFrame* s);
N_NOINLINE(void, stackoverflow_20001)(void);
static N_INLINE(void, popFrame)(void);
N_NIMCALL(void, unmapmem_234409)(Memfile234208* f, void* p, NI size);
N_NIMCALL(Memfile234208, open_234607)(NimStringDesc* filename, NU8 mode, NI mappedsize, NI offset, NI newfilesize);
N_NIMCALL(void, failedassertimpl_88817)(NimStringDesc* msg);
N_NIMCALL(NI16*, newwidecstring_81205)(NimStringDesc* s);
N_NIMCALL(void, close_235229)(Memfile234208* f);
STRING_LITERAL(TMP3715, "newFileSize == -1 or not (mode == fmRead) ", 42);
extern TY107429 Dl_107428;
extern TFrame* frameptr_17042;
extern TY107602 Dl_107601;
extern TY107318 Dl_107317;
extern TY105425 Dl_105424;
extern TY107411 Dl_107410;
extern TY107405 Dl_107404;
extern TY107440 Dl_107439;
extern TY107421 Dl_107420;
TNimType NTI234208; /* MemFile */
extern TNimType NTI153; /* pointer */
extern TNimType NTI108; /* int */

static N_INLINE(NI, chckRange)(NI i, NI a, NI b) {
	NI result;
{	result = 0;
	{
		NIM_BOOL LOC3;
		LOC3 = 0;
		LOC3 = (a <= i);
		if (!(LOC3)) goto LA4;
		LOC3 = (i <= b);
		LA4: ;
		if (!LOC3) goto LA5;
		result = i;
		goto BeforeRet;
	}
	goto LA1;
	LA5: ;
	{
		raiseRangeError(((NI64) (i)));
	}
	LA1: ;
	}BeforeRet: ;
	return result;
}

static N_INLINE(void, nimFrame)(TFrame* s) {
	NI LOC1;
	LOC1 = 0;
	{
		if (!(frameptr_17042 == NIM_NIL)) goto LA4;
		LOC1 = ((NI) 0);
	}
	goto LA2;
	LA4: ;
	{
		LOC1 = ((NI) ((NI16)((*frameptr_17042).calldepth + ((NI16) 1))));
	}
	LA2: ;
	(*s).calldepth = ((NI16) (LOC1));
	(*s).prev = frameptr_17042;
	frameptr_17042 = s;
	{
		if (!((*s).calldepth == ((NI16) 2000))) goto LA9;
		stackoverflow_20001();
	}
	LA9: ;
}

static N_INLINE(void, popFrame)(void) {
	frameptr_17042 = (*frameptr_17042).prev;
}

N_NIMCALL(void*, mapmem_234220)(Memfile234208* m, NU8 mode, NI mappedsize, NI offset) {
	void* result;
	NIM_BOOL readonly;
	NI32 LOC1;
	NI LOC7;
	nimfr("mapMem", "memfiles.nim")
	result = 0;
	nimln(41, "memfiles.nim");
	readonly = (mode == ((NU8) 0));
	nimln(43, "memfiles.nim");
	LOC1 = 0;
	nimln(45, "memfiles.nim");
	{
		if (!readonly) goto LA4;
		LOC1 = ((NI32) 4);
	}
	goto LA2;
	LA4: ;
	{
		LOC1 = ((NI32) 2);
	}
	LA2: ;
	nimln(46, "memfiles.nim");
	nimln(47, "memfiles.nim");
	LOC7 = 0;
	nimln(48, "memfiles.nim");
	{
		if (!(mappedsize == ((NI) -1))) goto LA10;
		LOC7 = ((NI) 0);
	}
	goto LA8;
	LA10: ;
	{
		LOC7 = mappedsize;
	}
	LA8: ;
	result = Dl_107428((*m).maphandle, LOC1, ((NI32)chckRange((NI)((NU64)(offset) >> (NU64)(((NI) 32))), ((NI32) (-2147483647 -1)), ((NI32) 2147483647))), ((NI32)chckRange((NI)(offset & ((NI) IL64(4294967295))), ((NI32) (-2147483647 -1)), ((NI32) 2147483647))), ((NI32)chckRange(LOC7, ((NI32) (-2147483647 -1)), ((NI32) 2147483647))), NIM_NIL);
	nimln(50, "memfiles.nim");
	{
		NI32 LOC17;
		if (!(result == NIM_NIL)) goto LA15;
		nimln(51, "memfiles.nim");
		LOC17 = 0;
		LOC17 = oslasterror_115454();
		raiseoserror_115430(LOC17);
	}
	LA15: ;
	popFrame();
	return result;
}

N_NIMCALL(void, unmapmem_234409)(Memfile234208* f, void* p, NI size) {
	nimfr("unmapMem", "memfiles.nim")
	nimln(70, "memfiles.nim");
	{
		NI32 LOC3;
		NI32 LOC6;
		LOC3 = 0;
		LOC3 = Dl_107601(p);
		if (!(LOC3 == ((NI32) 0))) goto LA4;
		LOC6 = 0;
		LOC6 = oslasterror_115454();
		raiseoserror_115430(LOC6);
	}
	LA4: ;
	popFrame();
}

N_NIMCALL(Memfile234208, open_234607)(NimStringDesc* filename, NU8 mode, NI mappedsize, NI offset, NI newfilesize) {
	Memfile234208 result;
	NIM_BOOL readonly;
	NI16* LOC7;
	NI32 LOC8;
	NI32 LOC14;
	NI32 LOC20;
	NI32 LOC64;
	NI32 LOC85;
	NI LOC91;
	NI32 hi;
	NI32 low;
	nimfr("open", "memfiles.nim")
	memset((void*)(&result), 0, sizeof(result));
	nimln(96, "memfiles.nim");
	{
		NIM_BOOL LOC3;
		LOC3 = 0;
		LOC3 = (newfilesize == ((NI) -1));
		if (LOC3) goto LA4;
		LOC3 = !((mode == ((NU8) 0)));
		LA4: ;
		if (!!(LOC3)) goto LA5;
		failedassertimpl_88817(((NimStringDesc*) &TMP3715));
	}
	LA5: ;
	nimln(97, "memfiles.nim");
	readonly = (mode == ((NU8) 0));
	nimln(123, "memfiles.nim");
	LOC7 = 0;
	LOC7 = newwidecstring_81205(filename);
	LOC8 = 0;
	{
		if (!readonly) goto LA11;
		LOC8 = ((NI32) (-2147483647 -1));
	}
	goto LA9;
	LA11: ;
	{
		LOC8 = ((NI32) 268435456);
	}
	LA9: ;
	LOC14 = 0;
	{
		if (!!((newfilesize == ((NI) -1)))) goto LA17;
		LOC14 = ((NI32) 2);
	}
	goto LA15;
	LA17: ;
	{
		LOC14 = ((NI32) 3);
	}
	LA15: ;
	LOC20 = 0;
	{
		if (!readonly) goto LA23;
		LOC20 = ((NI32) 1);
	}
	goto LA21;
	LA23: ;
	{
		LOC20 = ((NI32) 256);
	}
	LA21: ;
	result.fhandle = Dl_107317(LOC7, LOC8, ((NI32) 1), NIM_NIL, LOC14, LOC20, ((NI) 0));
	nimln(127, "memfiles.nim");
	{
		NI32 LOC40;
		if (!(result.fhandle == ((NI) -1))) goto LA28;
		nimln(100, "memfiles.nim");
		result.mem = NIM_NIL;
		nimln(101, "memfiles.nim");
		result.size = ((NI) 0);
		nimln(106, "memfiles.nim");
		{
			NI32 LOC34;
			if (!!((result.fhandle == ((NI) 0)))) goto LA32;
			LOC34 = 0;
			LOC34 = Dl_105424(result.fhandle);
		}
		LA32: ;
		nimln(107, "memfiles.nim");
		{
			NI32 LOC39;
			if (!!((result.maphandle == ((NI) 0)))) goto LA37;
			LOC39 = 0;
			LOC39 = Dl_105424(result.maphandle);
		}
		LA37: ;
		nimln(108, "memfiles.nim");
		nimln(128, "memfiles.nim");
		LOC40 = 0;
		LOC40 = oslasterror_115454();
		raiseoserror_115430(LOC40);
	}
	LA28: ;
	nimln(130, "memfiles.nim");
	{
		NI32 sizehigh;
		NI32 sizelow;
		NI32 status;
		NI32 lasterr;
		if (!!((newfilesize == ((NI) -1)))) goto LA43;
		nimln(132, "memfiles.nim");
		sizehigh = ((NI32)chckRange((NI)((NU64)(newfilesize) >> (NU64)(((NI) 32))), ((NI32) (-2147483647 -1)), ((NI32) 2147483647)));
		nimln(133, "memfiles.nim");
		sizelow = ((NI32)chckRange((NI)(newfilesize & ((NI) IL64(4294967295))), ((NI32) (-2147483647 -1)), ((NI32) 2147483647)));
		nimln(135, "memfiles.nim");
		status = Dl_107410(result.fhandle, sizelow, (&sizehigh), ((NI32) 0));
		nimln(137, "memfiles.nim");
		lasterr = oslasterror_115454();
		nimln(138, "memfiles.nim");
		{
			NIM_BOOL LOC47;
			NIM_BOOL LOC48;
			NI32 LOC51;
			LOC47 = 0;
			LOC48 = 0;
			LOC48 = (status == ((NI32) -1));
			if (!(LOC48)) goto LA49;
			LOC48 = !((lasterr == ((NI32) 0)));
			LA49: ;
			LOC47 = LOC48;
			if (LOC47) goto LA50;
			nimln(139, "memfiles.nim");
			LOC51 = 0;
			LOC51 = Dl_107404(result.fhandle);
			LOC47 = (LOC51 == ((NI32) 0));
			LA50: ;
			if (!LOC47) goto LA52;
			nimln(100, "memfiles.nim");
			result.mem = NIM_NIL;
			nimln(101, "memfiles.nim");
			result.size = ((NI) 0);
			nimln(106, "memfiles.nim");
			{
				NI32 LOC58;
				if (!!((result.fhandle == ((NI) 0)))) goto LA56;
				LOC58 = 0;
				LOC58 = Dl_105424(result.fhandle);
			}
			LA56: ;
			nimln(107, "memfiles.nim");
			{
				NI32 LOC63;
				if (!!((result.maphandle == ((NI) 0)))) goto LA61;
				LOC63 = 0;
				LOC63 = Dl_105424(result.maphandle);
			}
			LA61: ;
			nimln(108, "memfiles.nim");
			raiseoserror_115430(lasterr);
		}
		LA52: ;
	}
	LA43: ;
	nimln(144, "memfiles.nim");
	LOC64 = 0;
	nimln(146, "memfiles.nim");
	{
		if (!readonly) goto LA67;
		LOC64 = ((NI32) 2);
	}
	goto LA65;
	LA67: ;
	{
		LOC64 = ((NI32) 4);
	}
	LA65: ;
	result.maphandle = Dl_107439(result.fhandle, NIM_NIL, LOC64, ((NI32) 0), ((NI32) 0), NIM_NIL);
	nimln(149, "memfiles.nim");
	{
		NI32 LOC84;
		if (!(result.maphandle == ((NI) 0))) goto LA72;
		nimln(100, "memfiles.nim");
		result.mem = NIM_NIL;
		nimln(101, "memfiles.nim");
		result.size = ((NI) 0);
		nimln(106, "memfiles.nim");
		{
			NI32 LOC78;
			if (!!((result.fhandle == ((NI) 0)))) goto LA76;
			LOC78 = 0;
			LOC78 = Dl_105424(result.fhandle);
		}
		LA76: ;
		nimln(107, "memfiles.nim");
		{
			NI32 LOC83;
			if (!!((result.maphandle == ((NI) 0)))) goto LA81;
			LOC83 = 0;
			LOC83 = Dl_105424(result.maphandle);
		}
		LA81: ;
		nimln(108, "memfiles.nim");
		nimln(150, "memfiles.nim");
		LOC84 = 0;
		LOC84 = oslasterror_115454();
		raiseoserror_115430(LOC84);
	}
	LA72: ;
	nimln(152, "memfiles.nim");
	LOC85 = 0;
	nimln(154, "memfiles.nim");
	{
		if (!readonly) goto LA88;
		LOC85 = ((NI32) 4);
	}
	goto LA86;
	LA88: ;
	{
		LOC85 = ((NI32) 2);
	}
	LA86: ;
	nimln(155, "memfiles.nim");
	nimln(156, "memfiles.nim");
	LOC91 = 0;
	nimln(157, "memfiles.nim");
	{
		if (!(mappedsize == ((NI) -1))) goto LA94;
		LOC91 = ((NI) 0);
	}
	goto LA92;
	LA94: ;
	{
		LOC91 = mappedsize;
	}
	LA92: ;
	result.mem = Dl_107428(result.maphandle, LOC85, ((NI32)chckRange((NI)((NU64)(offset) >> (NU64)(((NI) 32))), ((NI32) (-2147483647 -1)), ((NI32) 2147483647))), ((NI32)chckRange((NI)(offset & ((NI) IL64(4294967295))), ((NI32) (-2147483647 -1)), ((NI32) 2147483647))), ((NI32)chckRange(LOC91, ((NI32) (-2147483647 -1)), ((NI32) 2147483647))), NIM_NIL);
	nimln(160, "memfiles.nim");
	{
		NI32 LOC111;
		if (!(result.mem == NIM_NIL)) goto LA99;
		nimln(100, "memfiles.nim");
		result.mem = NIM_NIL;
		nimln(101, "memfiles.nim");
		result.size = ((NI) 0);
		nimln(106, "memfiles.nim");
		{
			NI32 LOC105;
			if (!!((result.fhandle == ((NI) 0)))) goto LA103;
			LOC105 = 0;
			LOC105 = Dl_105424(result.fhandle);
		}
		LA103: ;
		nimln(107, "memfiles.nim");
		{
			NI32 LOC110;
			if (!!((result.maphandle == ((NI) 0)))) goto LA108;
			LOC110 = 0;
			LOC110 = Dl_105424(result.maphandle);
		}
		LA108: ;
		nimln(108, "memfiles.nim");
		nimln(161, "memfiles.nim");
		LOC111 = 0;
		LOC111 = oslasterror_115454();
		raiseoserror_115430(LOC111);
	}
	LA99: ;
	hi = 0;
	low = 0;
	nimln(164, "memfiles.nim");
	low = Dl_107420(result.fhandle, (&hi));
	nimln(165, "memfiles.nim");
	{
		NI32 LOC126;
		if (!(low == ((NI32) -1))) goto LA114;
		nimln(100, "memfiles.nim");
		result.mem = NIM_NIL;
		nimln(101, "memfiles.nim");
		result.size = ((NI) 0);
		nimln(106, "memfiles.nim");
		{
			NI32 LOC120;
			if (!!((result.fhandle == ((NI) 0)))) goto LA118;
			LOC120 = 0;
			LOC120 = Dl_105424(result.fhandle);
		}
		LA118: ;
		nimln(107, "memfiles.nim");
		{
			NI32 LOC125;
			if (!!((result.maphandle == ((NI) 0)))) goto LA123;
			LOC125 = 0;
			LOC125 = Dl_105424(result.maphandle);
		}
		LA123: ;
		nimln(108, "memfiles.nim");
		nimln(166, "memfiles.nim");
		LOC126 = 0;
		LOC126 = oslasterror_115454();
		raiseoserror_115430(LOC126);
	}
	goto LA112;
	LA114: ;
	{
		NI64 filesize;
		nimln(168, "memfiles.nim");
		filesize = (NI64)((NI64)((NU64)(((NI64) (hi))) >> (NU64)(IL64(32))) | ((NI64) (low)));
		nimln(169, "memfiles.nim");
		{
			if (!!((mappedsize == ((NI) -1)))) goto LA130;
			result.size = ((NI) (((filesize <= ((NI64) (mappedsize))) ? filesize : ((NI64) (mappedsize)))));
		}
		goto LA128;
		LA130: ;
		{
			nimln(170, "memfiles.nim");
			result.size = ((NI) (filesize));
		}
		LA128: ;
	}
	LA112: ;
	popFrame();
	return result;
}

N_NIMCALL(void, close_235229)(Memfile234208* f) {
	NIM_BOOL error;
	NI32 lasterr;
	nimfr("close", "memfiles.nim")
	nimln(222, "memfiles.nim");
	error = NIM_FALSE;
	lasterr = 0;
	nimln(226, "memfiles.nim");
	{
		NI32 LOC5;
		NIM_BOOL LOC6;
		NI32 LOC7;
		NIM_BOOL LOC9;
		NI32 LOC10;
		if (!!(((*f).fhandle == ((NI) -1)))) goto LA3;
		nimln(227, "memfiles.nim");
		LOC5 = 0;
		LOC5 = Dl_107601((*f).mem);
		error = (LOC5 == ((NI32) 0));
		nimln(228, "memfiles.nim");
		lasterr = oslasterror_115454();
		nimln(229, "memfiles.nim");
		LOC6 = 0;
		LOC7 = 0;
		LOC7 = Dl_105424((*f).maphandle);
		LOC6 = (LOC7 == ((NI32) 0));
		if (LOC6) goto LA8;
		LOC6 = error;
		LA8: ;
		error = LOC6;
		nimln(230, "memfiles.nim");
		LOC9 = 0;
		LOC10 = 0;
		LOC10 = Dl_105424((*f).fhandle);
		LOC9 = (LOC10 == ((NI32) 0));
		if (LOC9) goto LA11;
		LOC9 = error;
		LA11: ;
		error = LOC9;
	}
	LA3: ;
	nimln(237, "memfiles.nim");
	(*f).size = ((NI) 0);
	nimln(238, "memfiles.nim");
	(*f).mem = NIM_NIL;
	nimln(241, "memfiles.nim");
	(*f).fhandle = ((NI) 0);
	nimln(242, "memfiles.nim");
	(*f).maphandle = ((NI) 0);
	nimln(246, "memfiles.nim");
	{
		if (!error) goto LA14;
		raiseoserror_115430(lasterr);
	}
	LA14: ;
	popFrame();
}
NIM_EXTERNC N_NOINLINE(void, stdlib_memfilesInit)(void) {
	nimfr("memfiles", "memfiles.nim")
	popFrame();
}

NIM_EXTERNC N_NOINLINE(void, stdlib_memfilesDatInit)(void) {
static TNimNode* TMP3889[4];
static TNimNode TMP3713[5];
NTI234208.size = sizeof(Memfile234208);
NTI234208.kind = 18;
NTI234208.base = 0;
NTI234208.flags = 3;
TMP3889[0] = &TMP3713[1];
TMP3713[1].kind = 1;
TMP3713[1].offset = offsetof(Memfile234208, mem);
TMP3713[1].typ = (&NTI153);
TMP3713[1].name = "mem";
TMP3889[1] = &TMP3713[2];
TMP3713[2].kind = 1;
TMP3713[2].offset = offsetof(Memfile234208, size);
TMP3713[2].typ = (&NTI108);
TMP3713[2].name = "size";
TMP3889[2] = &TMP3713[3];
TMP3713[3].kind = 1;
TMP3713[3].offset = offsetof(Memfile234208, fhandle);
TMP3713[3].typ = (&NTI108);
TMP3713[3].name = "fHandle";
TMP3889[3] = &TMP3713[4];
TMP3713[4].kind = 1;
TMP3713[4].offset = offsetof(Memfile234208, maphandle);
TMP3713[4].typ = (&NTI108);
TMP3713[4].name = "mapHandle";
TMP3713[0].len = 4; TMP3713[0].kind = 2; TMP3713[0].sons = &TMP3889[0];
NTI234208.node = &TMP3713[0];
}

